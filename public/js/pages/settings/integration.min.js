!function(t){var e={};function i(a){if(e[a])return e[a].exports;var n=e[a]={i:a,l:!1,exports:{}};return t[a].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=t,i.c=e,i.d=function(t,e,a){i.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:a})},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=21)}({21:function(t,e,i){t.exports=i("NtXs")},NtXs:function(t,e){new Vue({el:"#app",data:{text:{addBtn:"Добавить",hideBtn:"Скрыть"},megaplan:!1,megaplanApplication:5972796,amocrm:!1,bitrix24:!1,errors:{host:!1,login:!1,token:!1},integrationData:{id:0,host:"",uuid:"",token:"",crm:"",login:"",accessToken:""},showSaveBtn:!0,disabledSelect:!1,disabledProgram:!1,disabledField:!1,disabledFieldType:!1,disabledAddBtn:!0,disabledHost:!1,selectProgramValue:"",program:[],fields:[],fieldType:[],showFieldDisable:!1,storedFields:[],storedParams:{program:"",field:"",type:"",contentType:""},storedParamsValue:{program:"",field:"",type:""},addFieldBtnName:"",responseData:"",selectedIndex:0,showPlus:!0,showMinus:!1,megaplanEmployee:{name:""}},mounted:function(){this.loadSettings()},methods:{loadSettings:function(){var t=this;window.axios.get("/settings/integration/crm/json").then(function(e){var i=e.data;i.crm_type&&t.showRelativePanel(i.crm_type),t.integrationData.id=i.id||0,t.integrationData.uuid=i.uuid||!1,t.integrationData.token=i.api_token||"",t.integrationData.crm=i.crm_type||"",t.integrationData.login=i.login||"",t.integrationData.host=i.host||"",t.integrationData.accessToken=i.access_token||"",t.storedFields=i.fields,t.disabledHost=t.disabledSelect=0!=i.id,t.addFieldBtnName=t.text.addBtn}).catch(function(t){})},showRelativePanel:function(t){this.megaplan="megaplan"===t,this.amocrm="amocrm"===t,this.bitrix24="bitrix24"===t},selectIntegration:function(t){this.host="",this.integrationData.crm=t.target.value,this.showRelativePanel(t.target.value),this.megaplan&&(this.showSaveBtn=!1),this.amocrm&&(this.showSaveBtn=!0),this.bitrix24&&(this.showSaveBtn=!1)},updateHost:function(t){this.integrationData.host=this.prepareHost(t.target.value),this.integrationData.host?this.errors.host=!1:this.errors.host=!0},updateLogin:function(t){this.integrationData.login=t.target.value,this.integrationData.login?this.errors.login=!1:this.errors.login=!0},updateToken:function(t){this.integrationData.token=t.target.value,this.integrationData.token?this.errors.token=!1:this.errors.token=!0},targetLink:function(t){var e="",i="";this.integrationData.host?(this.errors.host=!1,this.errors.host||(this.integrationData.host=this.prepareHost(this.integrationData.host),"megaplan"===this.integrationData.crm&&(e="https://"+this.integrationData.host+"/settings/application/install/"+this.megaplanApplication,this.showSaveBtn=!0,i={crm:this.integrationData.crm}),"bitrix24"===this.integrationData.crm&&(e="https://"+this.integrationData.host+"/marketplace/detail/telefum24.kp10/",i={crm:this.integrationData.crm,host:this.integrationData.host},this.disabledHost=!0),window.axios.post("/settings/integration/set/cookies",i).then(function(t){window.open(e,"_self")}).catch(function(t){window.ajaxError(t)}))):this.errors.host=!0},prepareHost:function(t){var e=t&&t.replace(/http(s)?\:\/\//i,"");return e&&e.split("/")[0]},saveIntegration:function(t){var e=this;this.integrationData.id?window.axios.put("/settings/integration/crm/"+this.integrationData.crm,this.integrationData).then(function(t){window.ajaxSuccess(t)}).catch(function(t){window.ajaxError(t)}):window.axios.post("/settings/integration/crm",this.integrationData).then(function(t){e.loadSettings()}).catch(function(t){window.ajaxError(t)})},selectProgram:function(t){var e=this;this.disabledProgram=!0,this.disabledField=!0,this.disabledFieldType=!0,this.disabledAddBtn=!0,this.storedParams.program=t.target.options[t.target.selectedIndex].innerHTML,this.storedParamsValue.program=t.target.value;var i=["DateField","StringField","MoneyField","EnumField","DateTimeField","FloatField","BoolField"];window.axios.get("/megaplan/programs/"+t.target.value+"/field").then(function(t){var a=t.data,n=a.program,s=[];e.responseData=a,n.forEach(function(t,e){-1!==i.indexOf(t.contentType)&&s.push({text:t.hrName,val:t.name,contentType:t.contentType})}),e.fields=s,e.disabledProgram=!1,e.disabledField=!1,e.disabledFieldType=!1}).catch(function(t){e.disabledProgram=!1,e.disabledField=!1,e.disabledFieldType=!1,e.disabledAddBtn=!1,window.ajaxError(t)})},showField:function(t){var e=this;this.showFieldDisable=!0,this.megaplan&&(0==this.program.length?window.axios.get("/megaplan/programs").then(function(t){var i=[];t.data.forEach(function(t,e){i.push({text:t.name,val:t.id})}),""!=e.storedParamsValue.program&&""!=e.storedParamsValue.field&&(e.disabledAddBtn=!1),e.program=i,e.addFieldBtnName=e.text.hideBtn,e.showFieldDisable=!1,e.showPlus=!1,e.showMinus=!0}).catch(function(t){window.ajaxError(t)}):(this.program=[],this.fields=[],this.showPlus=!0,this.showMinus=!1,this.showFieldDisable=!1,this.addFieldBtnName=this.text.addBtn)),this.amocrm&&(this.fields.length?(this.fields=[],this.showPlus=!0,this.showMinus=!1,this.showFieldDisable=!1,this.addFieldBtnName=this.text.addBtn):window.axios.get("/amocrm/leads/fields").then(function(t){t.data.length?(e.fields=t.data.filter(function(t){if(15!=t.field_type&&5!=t.field_type&&13!=t.field_type)return!0}),e.addFieldBtnName=e.text.hideBtn,e.showFieldDisable=!1,e.showPlus=!1,e.showMinus=!0):e.fields=[{id:"-1",name:"Список полей пуст"}]}).catch(function(t){window.ajaxError(t)})),this.bitrix24&&(this.fields.length?(this.fields=[],this.showPlus=!0,this.showMinus=!1,this.showFieldDisable=!1,this.addFieldBtnName=this.text.addBtn):window.axios.get("/bitrix24/deal/fields").then(function(t){var i=t.data;i.length?($.each(i,function(t,i){e.fields.push({id:i.field_id,name:i.field_name,field_type:i.field_type,enums:i.items})}),e.addFieldBtnName=e.text.hideBtn,e.showFieldDisable=!1,e.showPlus=!1,e.showMinus=!0):e.fields=[{id:"-1",name:"Список полей пуст"}]}).catch(function(t){window.ajaxError(t)}))},selectField:function(t){this.megaplan&&(this.storedParams.field=t.target.options[t.target.selectedIndex].innerHTML,this.storedParamsValue.field=t.target.value,this.storedParams.contentType=t.target.options[t.target.selectedIndex].dataset.contenttype,this.selectedIndex=t.target.selectedIndex,""!=this.storedParamsValue.program&&""!=this.storedParamsValue.field&&(this.disabledAddBtn=!1)),this.amocrm&&(this.storedParamsValue.field=t.target.value,this.disabledAddBtn=!1),this.bitrix24&&(this.storedParamsValue.field=t.target.value,this.disabledAddBtn=!1)},addRow:function(t){var e=this;if(this.megaplan){var i=this.responseData.program[this.selectedIndex-1].type,a=this.responseData.program[this.selectedIndex-1].refContentType,n=this.responseData.program[this.selectedIndex-1].enumValues;-1!=this.storedParamsValue.program&&-1!=this.storedParamsValue.field&&-1!=this.storedParamsValue.type&&window.axios.post("/settings/integration/crm/megaplan/program",{program_name:this.storedParams.program,program_id:this.storedParamsValue.program,field_name:this.storedParams.field,field_id:this.storedParamsValue.field,type:i,refContentType:a,enumValues:n,content_type:this.storedParams.contentType}).then(function(t){e.storedFields.push({program_name:e.storedParams.program,field_name:e.storedParams.field,type_name:e.storedParams.type})}).catch(function(t){window.ajaxError(t)})}if(this.amocrm&&this.storedParamsValue.field){if(this.storedFields.filter(function(t){return t.field_id==e.storedParamsValue.field}).length)return;var s=this.fields.filter(function(t){return t.id==e.storedParamsValue.field});s.length&&(s=s[0],window.axios.post("/settings/integration/crm/amocrm/lead/field",s).then(function(t){e.storedFields.push({amocrm_field_id:s.id,amocrm_field_name:s.name})}).catch(function(t){window.ajaxError(t)}))}if(this.bitrix24&&this.storedParamsValue.field){if(this.storedFields)if(this.storedFields.filter(function(t){return t.bitrix24_field_id==e.storedParamsValue.field}).length)return;var o=this.fields.filter(function(t){return t.id==e.storedParamsValue.field});o.length&&(o=o[0],window.axios.post("/settings/integration/crm/bitrix24/deal/field",o).then(function(t){e.storedFields.push({bitrix24_field_id:o.id,bitrix24_field_name:o.name})}).catch(function(t){window.ajaxError(t)}))}},deleteRow:function(t,e){var i=this;this.megaplan&&window.axios.delete("/settings/integration/crm/megaplan/"+e.field_id+"/program").then(function(e){i.storedFields.splice(t,1)}).catch(function(t){window.ajaxError(t)}),this.amocrm&&window.axios.delete("/settings/integration/crm/amocrm/lead/field/"+e.amocrm_field_id).then(function(e){i.storedFields.splice(t,1)}).catch(function(t){window.ajaxError(t)}),this.bitrix24&&window.axios.delete("/settings/integration/crm/bitrix24/deal/field/"+e.bitrix24_field_id).then(function(e){i.storedFields.splice(t,1)}).catch(function(t){window.ajaxError(t)})},deleteIntegration:function(t){var e=this;window.axios.delete("/settings/integration/crm/"+this.integrationData.crm).then(function(t){window.ajaxSuccess(t),e.integrationData.id=0,e.integrationData.uuid="",e.integrationData.token="",e.integrationData.crm="",e.integrationData.login="",e.integrationData.host="",e.integrationData.accessToken="",e.disabledSelect=!1,e.disabledHost=!1,e.showRelativePanel("")}).catch(function(t){window.ajaxError(t)})}}})}});